---
- name: Configure Windows EC2 Instances in Elastic Beanstalk
  hosts: windows
  tasks:
    - name: Ensure C:\temp directory exists
      win_file:
        path: 'C:\temp'
        state: directory

    - name: Download WebDeploy Installer
      win_get_url:
        url: "https://my-s3-bucket-for-jenkins-pipeline-setup.s3.amazonaws.com/webdeploy_amd64_en-US.msi"
        dest: "C:\\temp\\WebDeploy_x64.msi"

    - name: Install WebDeploy
      win_package:
        path: 'C:\\temp\\WebDeploy_x64.msi'
        state: present
        arguments: '/quiet'

    - name: Create WebDeploy Admin User
      win_user:
        name: "webdeployadmin"
        password: "{{ lookup('env', 'WEBDEPLOYADMIN_PASSWORD') }}"
        state: present

    - name: Add WebDeploy Admin to Administrators Group
      win_group_membership:
        name: Administrators
        members: webdeployadmin
        state: present

    - name: Restart Web Management Service (WMSVC)
      win_service:
        name: WMSVC
        state: restarted

    - name: Ensure login.aspx is added to Default Documents
      win_shell: |
        Import-Module WebAdministration
        $site = Get-Website -Name 'Default Web Site'
        if ($site) {
          if (-not ($site.DefaultDocuments | Where-Object { $_ -eq 'login.aspx' })) {
            Add-WebConfigurationProperty -pspath 'MACHINE/WEBROOT/APPHOST' -filter "system.webServer/defaultDocument/files" -name "." -value @{value='login.aspx'} -location 'Default Web Site'
          }
        }

    - name: Ensure Default Web Site is running
      win_iis_website:
        name: Default Web Site
        state: started

    - name: Restart IIS AppPool using PowerShell
      win_shell: |
        Import-Module WebAdministration
        Restart-WebAppPool -Name 'DefaultAppPool'

    - name: Clean up installer
      win_file:
        path: 'C:\\temp\\WebDeploy_x64.msi'
        state: absent

    - name: Restart IIS to apply changes
      win_service:
        name: W3SVC
        state: restarted

    - name: Create a Self-Signed Certificate
      win_shell: |
        New-SelfSignedCertificate -DnsName 'yourdomain.com' -CertStoreLocation Cert:\LocalMachine\My

    - name: Bind SSL Certificate to Default Web Site
      win_shell: |
        Import-Module WebAdministration
        $cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object { $_.DnsName -eq 'yourdomain.com' }
        New-WebBinding -Name 'Default Web Site' -Protocol https -Port 443 -SslFlags 1
        Set-ItemProperty IIS:\SslBindings\0.0.0.0!443 -name SslCertificateStoreName -value 'My'
        Set-ItemProperty IIS:\SslBindings\0.0.0.0!443 -name SslCertificateHash -value $cert.Thumbprint

    - name: Set IIS Authentication to Windows Authentication
      win_shell: |
        Import-Module WebAdministration
        Set-WebConfigurationProperty -Filter "/system.webServer/security/authentication/windowsAuthentication" -Name "enabled" -Value "True" -PSPath "IIS:\Sites\Default Web Site"
